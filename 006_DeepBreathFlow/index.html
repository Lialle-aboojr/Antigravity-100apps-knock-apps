<!DOCTYPE html>
<html lang="ja">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Deep Breath Flow V4</title>
    <!-- Google Fonts: Noto Sans JP for beautiful Japanese text -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@300;400;500;700&display=swap"
        rel="stylesheet">
    <style>
        /* =========================================
           Âü∫Êú¨Ë®≠ÂÆö / Basic Setup
           ========================================= */
        body {
            margin: 0;
            padding: 0;
            font-family: 'Noto Sans JP', sans-serif;
            height: 100vh;
            width: 100vw;
            overflow: hidden;
            display: flex;
            justify-content: center;
            align-items: center;
            flex-direction: column;
            /* „Ç™„Éº„É≠„É©È¢®„Ç∞„É©„Éá„Éº„Ç∑„Éß„É≥ËÉåÊôØ / Aurora Gradient Background */
            background: linear-gradient(135deg, #a8edea 0%, #fed6e3 100%);
            background-size: 400% 400%;
            animation: gradientBG 15s ease infinite;
            color: #333;
        }

        @keyframes gradientBG {
            0% {
                background-position: 0% 50%;
            }

            50% {
                background-position: 100% 50%;
            }

            100% {
                background-position: 0% 50%;
            }
        }

        /* =========================================
           UI „Éë„Éº„ÉÑ / UI Components
           ========================================= */

        /* ÂÖ±ÈÄöGlassmorphism„Çπ„Çø„Ç§„É´ */
        .glass-panel {
            background: rgba(255, 255, 255, 0.25);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.4);
            box-shadow: 0 4px 15px rgba(31, 38, 135, 0.1);
        }

        /* „Éò„ÉÉ„ÉÄ„Éº„Éª„Çø„Éñ / Header & Tabs */
        .header {
            position: absolute;
            top: 20px;
            width: 95%;
            /* Â∞ë„ÅóÂ∫É„Åí„Çã */
            max-width: 650px;
            display: flex;
            justify-content: center;
            gap: 8px;
            /* „ÇÆ„É£„ÉÉ„ÉóÂæÆË™øÊï¥ */
            z-index: 20;
        }

        .mode-tab {
            flex: 1;
            padding: 12px 5px;
            text-align: center;
            border-radius: 12px;
            cursor: pointer;
            font-size: 0.85rem;
            /* „Çµ„Ç§„Ç∫Ë™øÊï¥ */
            font-weight: 500;
            color: #4a7c8f;
            transition: all 0.3s ease;
            user-select: none;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }

        .mode-tab:hover {
            background: rgba(255, 255, 255, 0.4);
        }

        .mode-tab.active {
            background: rgba(255, 255, 255, 0.65);
            color: #1a5f7a;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
            font-weight: 700;
            transform: translateY(-1px);
        }

        .tab-title {
            font-size: 0.95rem;
            margin-bottom: 2px;
        }

        .tab-sub {
            font-size: 0.75rem;
            opacity: 0.8;
        }

        /* „É°„Ç§„É≥„Ç≥„É≥„ÉÜ„É≥„ÉÑ / Main Content */
        .container {
            position: relative;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 10;
            width: 100%;
        }

        .mode-title {
            margin-bottom: 20px;
            font-size: 1.2rem;
            color: #1a5f7a;
            opacity: 0.9;
            letter-spacing: 0.05em;
            text-align: center;
            font-weight: 700;
        }

        .circle-container {
            position: relative;
            width: 320px;
            height: 320px;
            display: flex;
            justify-content: center;
            align-items: center;
            margin-bottom: 30px;
            /* ‰∏ã„Å´„Çπ„Éö„Éº„Çπ */
        }

        .circle {
            width: 280px;
            height: 280px;
            border-radius: 50%;
            box-shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.15);
            display: flex;
            justify-content: center;
            align-items: center;
            flex-direction: column;
            transition: transform 1s ease-in-out;
            position: absolute;
        }

        .instruction-text {
            font-size: 1.8rem;
            font-weight: 700;
            color: #1a5f7a;
            letter-spacing: 0.1em;
            margin-bottom: 5px;
            text-align: center;
        }

        .countdown-text {
            font-size: 4rem;
            font-weight: 300;
            color: #1a5f7a;
            line-height: 1;
        }

        .sub-text {
            font-size: 0.9rem;
            margin-top: 10px;
            color: #4a7c8f;
        }

        /* Ë™¨Êòé„Ç®„É™„Ç¢ / Description Area */
        .description-box {
            width: 85%;
            max-width: 500px;
            padding: 15px 20px;
            margin-bottom: 25px;
            border-radius: 15px;
            text-align: center;
            font-size: 0.95rem;
            line-height: 1.6;
            color: #2c5464;
            transition: opacity 0.3s ease;
        }

        /* „Ç≥„É≥„Éà„É≠„Éº„É´„Ç®„É™„Ç¢ / Controls Area */
        .controls-area {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 20px;
            width: 100%;
        }

        .button-group {
            display: flex;
            gap: 15px;
        }

        .btn {
            padding: 12px 30px;
            font-size: 1rem;
            border-radius: 30px;
            cursor: pointer;
            outline: none;
            transition: all 0.2s ease;
            letter-spacing: 0.05em;
            border: none;
            color: #fff;
        }

        .btn-start {
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
            box-shadow: 0 4px 15px rgba(79, 172, 254, 0.4);
            font-weight: bold;
            display: block;
        }

        .btn-start:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(79, 172, 254, 0.6);
        }

        .btn-start:active {
            transform: translateY(1px);
        }

        .btn-reset {
            background: rgba(255, 100, 100, 0.2);
            color: #d64a4a;
            border: 1px solid rgba(255, 100, 100, 0.3);
            display: none;
            /* ÂàùÊúü„ÅØÈùûË°®Á§∫ */
        }

        .btn-reset:hover {
            background: rgba(255, 100, 100, 0.3);
        }

        /* „Çµ„Ç¶„É≥„Éâ„Çπ„Ç§„ÉÉ„ÉÅ / Sound Toggle */
        .sound-toggle {
            display: flex;
            align-items: center;
            gap: 10px;
            background: rgba(255, 255, 255, 0.3);
            padding: 8px 16px;
            border-radius: 20px;
            cursor: pointer;
            user-select: none;
            transition: background 0.2s;
        }

        .sound-toggle:hover {
            background: rgba(255, 255, 255, 0.5);
        }

        .toggle-icon {
            font-size: 1.2rem;
        }

        .toggle-label {
            font-size: 0.85rem;
            color: #4a7c8f;
        }
    </style>
</head>

<body>

    <!-- „Éò„ÉÉ„ÉÄ„Éº („É¢„Éº„ÉâÂàáÊõø) -->
    <header class="header">
        <div class="glass-panel mode-tab active" data-mode="4-7-8">
            <div class="tab-title">Relax</div>
            <div class="tab-sub">4-7-8</div>
        </div>
        <div class="glass-panel mode-tab" data-mode="box">
            <div class="tab-title">Box</div>
            <div class="tab-sub">4-4-4-4</div>
        </div>
        <div class="glass-panel mode-tab" data-mode="coherent">
            <div class="tab-title">Coherent</div>
            <div class="tab-sub">5-5</div>
        </div>
    </header>

    <div class="container">
        <div class="mode-title" id="mode-title">Relax (4-7-8) Mode</div>

        <!-- ÂëºÂê∏„Çµ„Éº„ÇØ„É´ -->
        <div class="circle-container">
            <div class="glass-panel circle" id="breathing-circle">
                <div class="instruction-text" id="status-text">Ready</div>
                <div class="countdown-text" id="countdown"></div>
                <div class="sub-text" id="sub-msg">Start„Éú„Çø„É≥„ÇíÊäº„Åó„Å¶„Åè„Å†„Åï„ÅÑ</div>
            </div>
        </div>

        <!-- „É¢„Éº„ÉâË™¨Êòé„Ç®„É™„Ç¢ (NEW) -->
        <div class="glass-panel description-box" id="mode-desc">
            ÂâØ‰∫§ÊÑüÁ•ûÁµå„ÇíÂÑ™‰Ωç„Å´„Åó„ÄÅÊ∑±„ÅÑ„É™„É©„ÉÉ„ÇØ„ÇπÂäπÊûú„Çí„ÇÇ„Åü„Çâ„Åó„Åæ„Åô„ÄÇÂØù„ÇãÂâç„Å´„Åä„Åô„Åô„ÇÅ„ÄÇ
        </div>

        <!-- „Ç≥„É≥„Éà„É≠„Éº„É´ -->
        <div class="controls-area">
            <div class="button-group">
                <button class="btn btn-start" id="start-btn">„Çπ„Çø„Éº„Éà</button>
                <button class="btn btn-reset glass-panel" id="reset-btn">„É™„Çª„ÉÉ„Éà</button>
            </div>

            <div class="sound-toggle glass-panel" id="sound-toggle">
                <span class="toggle-icon" id="sound-icon">üîá</span>
                <span class="toggle-label" id="sound-label">Sound OFF</span>
            </div>
        </div>
    </div>

    <script>
        /**
         * „Ç¢„Éó„É™Ë®≠ÂÆö / Configuration
         */
        const MODES = {
            '4-7-8': {
                title: 'Relax (4-7-8) Mode',
                description: 'ÂâØ‰∫§ÊÑüÁ•ûÁµå„ÇíÂÑ™‰Ωç„Å´„Åó„ÄÅÊ∑±„ÅÑ„É™„É©„ÉÉ„ÇØ„ÇπÂäπÊûú„Çí„ÇÇ„Åü„Çâ„Åó„Åæ„Åô„ÄÇÂØù„ÇãÂâç„Å´„Åä„Åô„Åô„ÇÅ„ÄÇ',
                steps: [
                    { text: 'Âê∏„Å£„Å¶', duration: 4, action: 'inhale', sub: 'Èºª„Åã„ÇâÈùô„Åã„Å´Âê∏„ÅÜ' },
                    { text: 'Ê≠¢„ÇÅ„Å¶', duration: 7, action: 'hold', sub: 'ÊÅØ„ÇíÊ≠¢„ÇÅ„Çã' },
                    { text: 'Âêê„ÅÑ„Å¶', duration: 8, action: 'exhale', sub: 'Âè£„Åã„ÇâÂº∑„ÅèÂêê„Åè' }
                ]
            },
            'box': {
                title: 'Box (4-4-4-4) Focus Mode',
                description: 'Á±≥ËªçÁâπÊÆäÈÉ®Èöä(NAVY SEALs)„ÇÇÊé°Áî®„ÄÇÂøÉ„ÇíËêΩ„Å°ÁùÄ„Åã„Åõ„ÄÅÈõÜ‰∏≠Âäõ„ÇíÊ•µÈôê„Åæ„ÅßÈ´ò„ÇÅ„Åæ„Åô„ÄÇ',
                steps: [
                    { text: 'Âê∏„Å£„Å¶', duration: 4, action: 'inhale', sub: '4Áßí„Åã„Åë„Å¶Âê∏„ÅÜ' },
                    { text: 'Ê≠¢„ÇÅ„Å¶', duration: 4, action: 'hold', sub: 'ËÇ∫„ÇíÊ∫Ä„Åü„Åó„Å¶Ê≠¢„ÇÅ„Çã' },
                    { text: 'Âêê„ÅÑ„Å¶', duration: 4, action: 'exhale', sub: '4Áßí„Åã„Åë„Å¶Âêê„Åè' },
                    { text: 'Ê≠¢„ÇÅ„Å¶', duration: 4, action: 'hold', sub: 'ËÇ∫„ÇíÁ©∫„Å´„Åó„Å¶Ê≠¢„ÇÅ„Çã' }
                ]
            },
            'coherent': {
                title: 'Coherent (5-5) Balance Mode',
                description: 'Ëá™ÂæãÁ•ûÁµå„ÅÆ„Éê„É©„É≥„Çπ„ÇíÊï¥„Åà„ÇãÂü∫Êú¨„ÅÆÂëºÂê∏Ê≥ï„ÄÇÂøÉÊãçÂ§âÂãï„ÇíÂÆâÂÆö„Åï„Åõ„Åæ„Åô„ÄÇ',
                steps: [
                    { text: 'Âê∏„Å£„Å¶', duration: 5, action: 'inhale', sub: 'ÂøÉÊãç„ÇíÊï¥„Åà„Çã' },
                    { text: 'Âêê„ÅÑ„Å¶', duration: 5, action: 'exhale', sub: 'Ëá™ÂæãÁ•ûÁµå„ÇíÊï¥„Åà„Çã' }
                ]
            }
        };

        // DOM Elements
        const elCircle = document.getElementById('breathing-circle');
        const elStatus = document.getElementById('status-text');
        const elCountdown = document.getElementById('countdown');
        const elSubMsg = document.getElementById('sub-msg');
        const elModeTitle = document.getElementById('mode-title');
        const elModeDesc = document.getElementById('mode-desc');
        const btnStart = document.getElementById('start-btn');
        const btnReset = document.getElementById('reset-btn');
        const toggleSound = document.getElementById('sound-toggle');
        const iconSound = document.getElementById('sound-icon');
        const labelSound = document.getElementById('sound-label');
        const tabs = document.querySelectorAll('.mode-tab');

        // State variables
        let currentMode = '4-7-8';
        let isRunning = false;
        let isSoundOn = false;
        let audioCtx = null;

        // Web Audio API Context Lazy Load
        function initAudio() {
            if (!audioCtx) {
                const AudioContext = window.AudioContext || window.webkitAudioContext;
                audioCtx = new AudioContext();
            }
            if (audioCtx.state === 'suspended') {
                audioCtx.resume();
            }
        }

        /**
         * „Çµ„Ç¶„É≥„ÉâÂÜçÁîü (Enhanced Tick)
         */
        function playTick(phase) {
            if (!isSoundOn || !audioCtx) return;

            const osc = audioCtx.createOscillator();
            const gain = audioCtx.createGain();

            osc.type = 'sine';

            let freqStart = 800;
            let freqEnd = 400;
            let gainStart = 0.1;
            let gainEnd = 0.001;
            let duration = 0.15;

            if (phase === 'exhale') {
                freqStart = 400;
                freqEnd = 200;
                gainStart = 0.08;
            } else if (phase === 'hold') {
                freqStart = 600;
                freqEnd = 500;
                gainStart = 0.03;
                duration = 0.1;
            } else if (phase === 'inhale') {
                // Default high pitch
            } else {
                freqStart = 660;
                freqEnd = 440;
            }

            osc.frequency.setValueAtTime(freqStart, audioCtx.currentTime);
            osc.frequency.exponentialRampToValueAtTime(freqEnd, audioCtx.currentTime + 0.1);

            gain.gain.setValueAtTime(gainStart, audioCtx.currentTime);
            gain.gain.exponentialRampToValueAtTime(gainEnd, audioCtx.currentTime + duration);

            osc.connect(gain);
            gain.connect(audioCtx.destination);

            osc.start();
            osc.stop(audioCtx.currentTime + duration + 0.05);
        }

        /**
         * „É¢„Éº„ÉâÂàá„ÇäÊõø„ÅàÂá¶ÁêÜ
         */
        tabs.forEach(tab => {
            tab.addEventListener('click', () => {
                if (isRunning) resetBreath();

                tabs.forEach(t => t.classList.remove('active'));
                tab.classList.add('active');

                // Update Mode and UI with Description
                currentMode = tab.dataset.mode;
                const modeData = MODES[currentMode];
                elModeTitle.innerText = modeData.title;
                elModeDesc.innerText = modeData.description; // Ë™¨ÊòéÊñáÊõ¥Êñ∞
            });
        });

        /* „Çµ„Ç¶„É≥„Éâ„Éà„Ç∞„É´ */
        toggleSound.addEventListener('click', () => {
            isSoundOn = !isSoundOn;
            if (isSoundOn) {
                initAudio();
                iconSound.innerText = 'üîä';
                labelSound.innerText = 'Sound ON';
                playTick('inhale');
            } else {
                iconSound.innerText = 'üîá';
                labelSound.innerText = 'Sound OFF';
            }
        });

        /* „Çπ„Çø„Éº„Éà & „É™„Çª„ÉÉ„Éà */
        btnStart.addEventListener('click', () => {
            if (isSoundOn) initAudio();
            startBreath();
        });

        btnReset.addEventListener('click', resetBreath);

        /**
         * ÂëºÂê∏„Éï„É≠„ÉºÂà∂Âæ° (Async/Await Pattern)
         */
        let abortController = null;

        async function startBreath() {
            if (isRunning) return;
            isRunning = true;
            abortController = new AbortController();

            btnStart.style.display = 'none';
            btnReset.style.display = 'block';
            elSubMsg.style.opacity = '0.6';

            try {
                while (isRunning) {
                    const steps = MODES[currentMode].steps;

                    for (const step of steps) {
                        if (!isRunning) break;
                        await runStep(step, abortController.signal);
                    }
                }
            } catch (err) {
                if (err.name === 'AbortError') {
                    console.log('Breathing cycle stopped.');
                } else {
                    console.error(err);
                }
            }
        }

        function runStep(step, signal) {
            return new Promise((resolve, reject) => {
                if (signal.aborted) return reject(new DOMException('Aborted', 'AbortError'));

                elStatus.innerText = step.text;
                elSubMsg.innerText = step.sub;

                elCircle.style.transitionDuration = `${step.duration}s`;
                elCircle.className = 'glass-panel circle';
                void elCircle.offsetWidth;

                if (step.action === 'inhale') {
                    elCircle.classList.add('expand');
                    elCircle.style.transform = 'scale(1.3)';
                } else if (step.action === 'exhale') {
                    elCircle.classList.add('shrink');
                    elCircle.style.transform = 'scale(1.0)';
                }

                let remaining = step.duration;
                elCountdown.innerText = remaining;
                if (remaining > 0) playTick(step.action);

                const timer = setInterval(() => {
                    if (signal.aborted) {
                        clearInterval(timer);
                        return reject(new DOMException('Aborted', 'AbortError'));
                    }

                    remaining--;
                    if (remaining > 0) {
                        elCountdown.innerText = remaining;
                        playTick(step.action);
                    } else {
                        elCountdown.innerText = '';
                        clearInterval(timer);
                        resolve();
                    }
                }, 1000);
            });
        }

        function resetBreath() {
            isRunning = false;
            if (abortController) {
                abortController.abort();
            }

            elStatus.innerText = 'Ready';
            elCountdown.innerText = '';
            elSubMsg.innerText = 'Start„Éú„Çø„É≥„ÇíÊäº„Åó„Å¶„Åè„Å†„Åï„ÅÑ';
            elSubMsg.style.opacity = '1';

            elCircle.style.transitionDuration = '0.5s';
            elCircle.style.transform = 'scale(1.0)';
            elCircle.className = 'glass-panel circle';

            btnStart.style.display = 'block';
            btnReset.style.display = 'none';
        }

    </script>
</body>

</html>